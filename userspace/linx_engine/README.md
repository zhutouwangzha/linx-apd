# LINX Engine - æ•°æ®é‡‡é›†å¼•æ“æ¨¡å—

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

`linx_engine` æ˜¯ç³»ç»Ÿçš„æ•°æ®é‡‡é›†å¼•æ“ï¼Œæä¾›æŠ½è±¡çš„æ•°æ®æºæ¥å£ï¼Œæ”¯æŒå¤šç§é©±åŠ¨ï¼ˆeBPFã€å†…æ ¸æ¨¡å—ã€æ’ä»¶ç­‰ï¼‰ã€‚å®ƒè´Ÿè´£ç®¡ç†æ‰€æœ‰äº‹ä»¶æºçš„åŠ è½½/å¸è½½ï¼Œä»¥åŠä»ä¸åŒäº‹ä»¶æºè¯»å–æ¶ˆæ¯ï¼Œä¸ºä¸Šå±‚æä¾›ç»Ÿä¸€çš„äº‹ä»¶è·å–æ¥å£ã€‚

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

- **å¤šé©±åŠ¨æ”¯æŒ**: æ”¯æŒeBPFã€å†…æ ¸æ¨¡å—ã€æ’ä»¶ç­‰å¤šç§æ•°æ®æº
- **ç»Ÿä¸€æ¥å£**: ä¸ºä¸åŒæ•°æ®æºæä¾›ç»Ÿä¸€çš„æ“ä½œæ¥å£
- **åŠ¨æ€åŠ è½½**: æ”¯æŒè¿è¡Œæ—¶åŠ¨æ€åŠ è½½å’Œå¸è½½æ•°æ®æº
- **äº‹ä»¶è·å–**: æä¾›é«˜æ•ˆçš„äº‹ä»¶è·å–æœºåˆ¶
- **é…ç½®é©±åŠ¨**: åŸºäºé…ç½®æ–‡ä»¶é€‰æ‹©å’Œé…ç½®æ•°æ®æº

## ğŸ—ï¸ æ¨¡å—ç»“æ„

```
linx_engine/
â”œâ”€â”€ include/
â”‚   â”œâ”€â”€ linx_engine.h           # ä¸»è¦æ¥å£å®šä¹‰
â”‚   â””â”€â”€ linx_engine_vtable.h    # è™šå‡½æ•°è¡¨å®šä¹‰
â”œâ”€â”€ ebpf/                       # eBPFé©±åŠ¨å®ç°
â”‚   â”œâ”€â”€ include/
â”‚   â”‚   â”œâ”€â”€ linx_engine_ebpf.h
â”‚   â”‚   â”œâ”€â”€ linx_ebpf_api.h
â”‚   â”‚   â””â”€â”€ linx_ebpf_common.h
â”‚   â”œâ”€â”€ linx_engine_ebpf.c      # eBPFå¼•æ“å®ç°
â”‚   â”œâ”€â”€ linx_ebpf_load.c        # eBPFç¨‹åºåŠ è½½
â”‚   â”œâ”€â”€ linx_ebpf_maps.c        # eBPFæ˜ å°„ç®¡ç†
â”‚   â””â”€â”€ linx_ebpf_ringbuf.c     # Ring Bufferå¤„ç†
â”œâ”€â”€ kmod/                       # å†…æ ¸æ¨¡å—é©±åŠ¨
â”‚   â””â”€â”€ include/
â”œâ”€â”€ plugin/                     # æ’ä»¶é©±åŠ¨æ¡†æ¶
â”‚   â””â”€â”€ include/
â”œâ”€â”€ linx_engine.c               # å¼•æ“æ ¸å¿ƒå®ç°
â””â”€â”€ Makefile                    # æ„å»ºé…ç½®
```

## ğŸ”§ æ ¸å¿ƒæ¥å£

### ä¸»è¦API

```c
// å¼•æ“ç®¡ç†æ¥å£
int linx_engine_init(linx_global_config_t *config);
int linx_engine_close(void);
int linx_engine_start(void);
int linx_engine_stop(void);

// äº‹ä»¶è·å–æ¥å£
int linx_engine_next(linx_event_t **event);
```

### è™šå‡½æ•°è¡¨æ¥å£

```c
typedef struct {
    int (*init)(void *config);           // åˆå§‹åŒ–æ•°æ®æº
    int (*destroy)(void);                // é”€æ¯æ•°æ®æº
    int (*start)(void);                  // å¯åŠ¨æ•°æ®é‡‡é›†
    int (*stop)(void);                   // åœæ­¢æ•°æ®é‡‡é›†
    int (*next)(linx_event_t **event);   // è·å–ä¸‹ä¸€ä¸ªäº‹ä»¶
    int (*get_msg)(void);                // è·å–æ¶ˆæ¯
} linx_engine_vtable_t;
```

### å¼•æ“ç»“æ„

```c
typedef struct {
    linx_engine_vtable_t *vtable;        // è™šå‡½æ•°è¡¨æŒ‡é’ˆ
} linx_engine_t;
```

## ğŸš€ eBPFé©±åŠ¨å­æ¨¡å—

### åŠŸèƒ½ç‰¹æ€§
- **ç¨‹åºåŠ è½½**: åŠ¨æ€åŠ è½½eBPFç¨‹åºåˆ°å†…æ ¸
- **æ˜ å°„ç®¡ç†**: ç®¡ç†eBPFæ˜ å°„çš„åˆ›å»ºå’Œè®¿é—®
- **Ring Buffer**: é«˜æ•ˆçš„å†…æ ¸-ç”¨æˆ·æ€æ•°æ®ä¼ è¾“
- **äº‹ä»¶è¿‡æ»¤**: åŸºäºé…ç½®çš„äº‹ä»¶è¿‡æ»¤æœºåˆ¶

### æ ¸å¿ƒæ–‡ä»¶

#### linx_engine_ebpf.c
- eBPFå¼•æ“çš„ä¸»è¦å®ç°
- å®ç°è™šå‡½æ•°è¡¨çš„æ‰€æœ‰æ¥å£
- ç®¡ç†eBPFç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸ

#### linx_ebpf_load.c
- è´Ÿè´£eBPFç¨‹åºçš„åŠ è½½å’Œé™„åŠ 
- å¤„ç†eBPFç¨‹åºçš„éªŒè¯å’Œé“¾æ¥
- ç®¡ç†eBPFç¨‹åºçš„å¸è½½

#### linx_ebpf_maps.c
- ç®¡ç†eBPFæ˜ å°„çš„åˆ›å»ºå’Œé…ç½®
- æä¾›æ˜ å°„çš„è¯»å†™æ¥å£
- å¤„ç†æ˜ å°„çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†

#### linx_ebpf_ringbuf.c
- å®ç°Ring Bufferçš„è¯»å–é€»è¾‘
- æä¾›é«˜æ•ˆçš„æ•°æ®ä¼ è¾“æœºåˆ¶
- å¤„ç†æ•°æ®çš„è§£æå’Œè½¬æ¢

### eBPFé…ç½®

```c
struct {
    bool drop_mode;                      // ä¸¢å¼ƒæ¨¡å¼
    bool drop_failed;                    // ä¸¢å¼ƒå¤±è´¥äº‹ä»¶
    uint32_t filter_pids[MAX_SIZE];      // PIDè¿‡æ»¤åˆ—è¡¨
    uint8_t filter_comms[MAX_SIZE][32];  // å‘½ä»¤è¿‡æ»¤åˆ—è¡¨
    uint8_t interest_syscall_table[MAX]; // æ„Ÿå…´è¶£çš„ç³»ç»Ÿè°ƒç”¨è¡¨
} ebpf_config;
```

## ğŸ”Œ æ’ä»¶é©±åŠ¨æ¡†æ¶

### æ’ä»¶æ¥å£
- åŠ¨æ€åº“åŠ è½½æœºåˆ¶
- æ ‡å‡†åŒ–çš„æ’ä»¶API
- æ’ä»¶é…ç½®å’Œç®¡ç†
- æ’ä»¶ç”Ÿå‘½å‘¨æœŸæ§åˆ¶

### æ”¯æŒçš„æ’ä»¶ç±»å‹
- **JSONæ’ä»¶**: å¤„ç†JSONæ ¼å¼çš„äº‹ä»¶æ•°æ®
- **K8sæ’ä»¶**: é›†æˆKubernetesäº‹ä»¶
- **è‡ªå®šä¹‰æ’ä»¶**: ç”¨æˆ·è‡ªå®šä¹‰çš„æ•°æ®æºæ’ä»¶

## ğŸ› ï¸ æ•°æ®æºç®¡ç†

### æ•°æ®æºé€‰æ‹©

å¼•æ“æ ¹æ®é…ç½®æ–‡ä»¶è‡ªåŠ¨é€‰æ‹©æ•°æ®æºï¼š

```yaml
engine:
  kind: ebpf                    # æ•°æ®æºç±»å‹ï¼šebpf/kmod/plugin
  ebpf:
    drop_mode: false
    drop_failed: true
    filter_pids: []
    filter_comms: []
    interest_syscall_file: "/path/to/syscalls.json"
```

### åˆå§‹åŒ–æµç¨‹

```mermaid
graph TD
    A[é…ç½®è§£æ] --> B{æ•°æ®æºç±»å‹}
    B -->|eBPF| C[åˆå§‹åŒ–eBPFé©±åŠ¨]
    B -->|KMOD| D[åˆå§‹åŒ–å†…æ ¸æ¨¡å—é©±åŠ¨]
    B -->|Plugin| E[åˆå§‹åŒ–æ’ä»¶é©±åŠ¨]
    C --> F[åŠ è½½ç¨‹åº/æ˜ å°„]
    D --> G[åŠ è½½å†…æ ¸æ¨¡å—]
    E --> H[åŠ è½½æ’ä»¶åº“]
    F --> I[å¯åŠ¨æ•°æ®é‡‡é›†]
    G --> I
    H --> I
```

## ğŸ“Š äº‹ä»¶å¤„ç†æµç¨‹

### äº‹ä»¶è·å–æµç¨‹

```mermaid
sequenceDiagram
    participant App as åº”ç”¨å±‚
    participant Engine as å¼•æ“æ ¸å¿ƒ
    participant Driver as é©±åŠ¨å±‚
    participant Kernel as å†…æ ¸
    
    App->>Engine: linx_engine_next()
    Engine->>Driver: vtable->next()
    Driver->>Kernel: è¯»å–Ring Buffer/è®¾å¤‡
    Kernel-->>Driver: åŸå§‹äº‹ä»¶æ•°æ®
    Driver-->>Engine: è§£æåçš„äº‹ä»¶
    Engine-->>App: linx_event_tç»“æ„
```

### æ•°æ®è½¬æ¢

1. **å†…æ ¸åŸå§‹æ•°æ®** â†’ **Ring Buffer**
2. **Ring Buffer** â†’ **é©±åŠ¨å±‚è§£æ**
3. **é©±åŠ¨å±‚è§£æ** â†’ **æ ‡å‡†äº‹ä»¶ç»“æ„**
4. **æ ‡å‡†äº‹ä»¶ç»“æ„** â†’ **åº”ç”¨å±‚å¤„ç†**

## âš¡ æ€§èƒ½ç‰¹æ€§

### é«˜æ€§èƒ½è®¾è®¡
- **é›¶æ‹·è´ä¼ è¾“**: eBPF Ring Bufferå®ç°é›¶æ‹·è´
- **æ‰¹é‡å¤„ç†**: æ”¯æŒæ‰¹é‡äº‹ä»¶è·å–
- **å†…å­˜æ± **: äº‹ä»¶å¯¹è±¡çš„å†…å­˜æ± ç®¡ç†
- **å¼‚æ­¥å¤„ç†**: éé˜»å¡çš„äº‹ä»¶è·å–æœºåˆ¶

### æ€§èƒ½ä¼˜åŒ–
- **äº‹ä»¶è¿‡æ»¤**: å†…æ ¸æ€äº‹ä»¶è¿‡æ»¤å‡å°‘æ•°æ®ä¼ è¾“
- **é€‰æ‹©æ€§é‡‡é›†**: åªé‡‡é›†æ„Ÿå…´è¶£çš„ç³»ç»Ÿè°ƒç”¨
- **åŠ¨æ€é…ç½®**: è¿è¡Œæ—¶è°ƒæ•´é‡‡é›†å‚æ•°

## ğŸ” ç›‘æ§å’Œè°ƒè¯•

### ç»Ÿè®¡ä¿¡æ¯
- é‡‡é›†äº‹ä»¶æ€»æ•°
- ä¸¢å¼ƒäº‹ä»¶æ•°é‡
- æ•°æ®ä¼ è¾“é€Ÿç‡
- å†…å­˜ä½¿ç”¨æƒ…å†µ

### è°ƒè¯•æ”¯æŒ
- è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
- äº‹ä»¶æ•°æ®è½¬å‚¨
- æ€§èƒ½æŒ‡æ ‡è¾“å‡º
- è°ƒè¯•æ¨¡å¼å¼€å…³

## âš™ï¸ é…ç½®é€‰é¡¹

### eBPFé©±åŠ¨é…ç½®

```yaml
ebpf:
  drop_mode: false              # æ˜¯å¦ä¸¢å¼ƒæ¨¡å¼
  drop_failed: true             # æ˜¯å¦ä¸¢å¼ƒå¤±è´¥äº‹ä»¶
  filter_pids: [1000, 1001]     # è¿‡æ»¤çš„PIDåˆ—è¡¨
  filter_comms: ["bash", "vim"] # è¿‡æ»¤çš„å‘½ä»¤åˆ—è¡¨
  interest_syscall_file: "/etc/linx_apd/syscalls.json"
```

### å†…æ ¸æ¨¡å—é…ç½®

```yaml
kmod:
  log_path: "/var/log/linx_kmod.log"  # å†…æ ¸æ¨¡å—æ—¥å¿—è·¯å¾„
```

### æ’ä»¶é…ç½®

```yaml
load_plugins: [json, k8s]       # è¦åŠ è½½çš„æ’ä»¶åˆ—è¡¨
plugin:
  - name: json
    library_path: "libplugin_json.so"
    init_config: ""
  - name: k8s
    library_path: "libplugin_k8s.so"
    init_config: "cluster_config"
```

## ğŸš¨ é”™è¯¯å¤„ç†

### é”™è¯¯ç±»å‹
- **åŠ è½½é”™è¯¯**: eBPFç¨‹åºæˆ–æ’ä»¶åŠ è½½å¤±è´¥
- **è¿è¡Œæ—¶é”™è¯¯**: æ•°æ®é‡‡é›†è¿‡ç¨‹ä¸­çš„é”™è¯¯
- **é…ç½®é”™è¯¯**: é…ç½®å‚æ•°æ— æ•ˆæˆ–å†²çª

### é”™è¯¯æ¢å¤
- è‡ªåŠ¨é‡è¯•æœºåˆ¶
- é™çº§å¤„ç†ç­–ç•¥
- é”™è¯¯çŠ¶æ€æŠ¥å‘Š
- ä¼˜é›…å¤±è´¥å¤„ç†

## ğŸ”— æ¨¡å—ä¾èµ–

### å¤–éƒ¨ä¾èµ–
- **libbpf**: eBPFç¨‹åºåŠ è½½å’Œç®¡ç†
- **libelf**: ELFæ–‡ä»¶å¤„ç†
- **zlib**: æ•°æ®å‹ç¼©æ”¯æŒ

### å†…éƒ¨ä¾èµ–
- `linx_config` - é…ç½®ç®¡ç†
- `linx_event` - äº‹ä»¶ç»“æ„å®šä¹‰
- `linx_log` - æ—¥å¿—è¾“å‡º

## ğŸš€ æ‰©å±•å¼€å‘

### æ·»åŠ æ–°é©±åŠ¨

1. å®ç°è™šå‡½æ•°è¡¨æ¥å£
2. æ³¨å†Œé©±åŠ¨åˆ°å¼•æ“
3. æ·»åŠ é…ç½®æ”¯æŒ
4. ç¼–å†™æµ‹è¯•ç”¨ä¾‹

### æ’ä»¶å¼€å‘

1. å®ç°æ’ä»¶APIæ¥å£
2. ç¼–è¯‘ä¸ºåŠ¨æ€åº“
3. é…ç½®æ’ä»¶å‚æ•°
4. éƒ¨ç½²å’ŒåŠ è½½

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨

```c
#include "linx_engine.h"

// åˆå§‹åŒ–å¼•æ“
linx_global_config_t *config = linx_config_get();
int ret = linx_engine_init(config);

// å¯åŠ¨æ•°æ®é‡‡é›†
ret = linx_engine_start();

// è·å–äº‹ä»¶
linx_event_t *event;
while (1) {
    ret = linx_engine_next(&event);
    if (ret > 0) {
        // å¤„ç†äº‹ä»¶
        process_event(event);
    }
}

// åœæ­¢å’Œæ¸…ç†
linx_engine_stop();
linx_engine_close();
```