# çº¿ç¨‹æ± æ–¹æ¡ˆ vs è‡ªå®šä¹‰çº¿ç¨‹æ–¹æ¡ˆå¯¹æ¯”åˆ†æ

## æ–¹æ¡ˆæ¦‚è¿°

### æ–¹æ¡ˆ1ï¼šåŸºäºç°æœ‰ linx_thread_poolï¼ˆæ¨èï¼‰
- **æ–‡ä»¶**: `linx_event_processor_v2.h/c`
- **æ ¸å¿ƒæ€æƒ³**: ä½¿ç”¨æ‚¨ç°æœ‰çš„`linx_thread_pool`ï¼Œé€šè¿‡ä»»åŠ¡æäº¤çš„æ–¹å¼å®ç°å¤šçº¿ç¨‹å¤„ç†
- **æ¶æ„**: ä»»åŠ¡é©±åŠ¨çš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼

### æ–¹æ¡ˆ2ï¼šè‡ªå®šä¹‰çº¿ç¨‹ç®¡ç†
- **æ–‡ä»¶**: `linx_event_processor.h/c`
- **æ ¸å¿ƒæ€æƒ³**: ç›´æ¥åˆ›å»ºå’Œç®¡ç†çº¿ç¨‹ï¼Œä½¿ç”¨ä¸“ç”¨çš„äº‹ä»¶é˜Ÿåˆ—
- **æ¶æ„**: ä¸“ç”¨çº¿ç¨‹çš„æµæ°´çº¿æ¨¡å¼

## è¯¦ç»†å¯¹æ¯”

### 1. æ¶æ„è®¾è®¡

| ç‰¹æ€§ | çº¿ç¨‹æ± æ–¹æ¡ˆ | è‡ªå®šä¹‰çº¿ç¨‹æ–¹æ¡ˆ |
|------|------------|----------------|
| **çº¿ç¨‹ç®¡ç†** | å¤ç”¨ç°æœ‰çº¿ç¨‹æ±  | åˆ›å»ºä¸“ç”¨çº¿ç¨‹ |
| **ä»»åŠ¡åˆ†é…** | åŠ¨æ€ä»»åŠ¡æäº¤ | å›ºå®šçº¿ç¨‹è§’è‰² |
| **èµ„æºå¤ç”¨** | é«˜ï¼ˆçº¿ç¨‹å¤ç”¨ï¼‰ | ä¸­ï¼ˆä¸“ç”¨çº¿ç¨‹ï¼‰ |
| **æ‰©å±•æ€§** | ä¼˜ç§€ | è‰¯å¥½ |

### 2. å®ç°å¤æ‚åº¦

| æ–¹é¢ | çº¿ç¨‹æ± æ–¹æ¡ˆ | è‡ªå®šä¹‰çº¿ç¨‹æ–¹æ¡ˆ |
|------|------------|----------------|
| **ä»£ç å¤æ‚åº¦** | â­â­â­ | â­â­â­â­ |
| **é›†æˆéš¾åº¦** | â­â­ | â­â­â­ |
| **ç»´æŠ¤æˆæœ¬** | â­â­ | â­â­â­â­ |
| **è°ƒè¯•éš¾åº¦** | â­â­â­ | â­â­â­â­ |

### 3. æ€§èƒ½ç‰¹å¾

| æ€§èƒ½æŒ‡æ ‡ | çº¿ç¨‹æ± æ–¹æ¡ˆ | è‡ªå®šä¹‰çº¿ç¨‹æ–¹æ¡ˆ |
|----------|------------|----------------|
| **å¯åŠ¨å¼€é”€** | ä½ | ä¸­ |
| **å†…å­˜ä½¿ç”¨** | ä½ | ä¸­ |
| **CPUæ•ˆç‡** | é«˜ | é«˜ |
| **å»¶è¿Ÿ** | ä½ | æä½ |
| **ååé‡** | é«˜ | é«˜ |

### 4. åŠŸèƒ½ç‰¹æ€§

#### çº¿ç¨‹æ± æ–¹æ¡ˆä¼˜åŠ¿
```c
// åŠ¨æ€ä»»åŠ¡æäº¤
linx_event_processor_v2_submit_fetch_tasks(count);
linx_event_processor_v2_submit_match_task(event);

// åˆ©ç”¨ç°æœ‰çº¿ç¨‹æ± åŠŸèƒ½
int active_threads = linx_thread_pool_get_active_threads(pool);
int queue_size = linx_thread_pool_get_queue_size(pool);

// ä»»åŠ¡ç±»å‹çµæ´»
typedef enum {
    TASK_TYPE_EVENT_FETCH,
    TASK_TYPE_RULE_MATCH,
    TASK_TYPE_BATCH_PROCESS
} linx_task_type_t;
```

#### è‡ªå®šä¹‰çº¿ç¨‹æ–¹æ¡ˆä¼˜åŠ¿
```c
// ä¸“ç”¨çº¿ç¨‹ï¼Œè§’è‰²æ˜ç¡®
void *linx_event_fetcher_thread(void *arg);
void *linx_rule_matcher_thread(void *arg);

// ç›´æ¥çš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼
linx_event_queue_push_event(queue, event);
linx_event_queue_pop_event(queue, event);
```

### 5. é€‚ç”¨åœºæ™¯

#### çº¿ç¨‹æ± æ–¹æ¡ˆé€‚åˆï¼š
- âœ… **ç°æœ‰ç³»ç»Ÿé›†æˆ** - å……åˆ†åˆ©ç”¨å·²æœ‰çš„çº¿ç¨‹æ± åŸºç¡€è®¾æ–½
- âœ… **åŠ¨æ€è´Ÿè½½** - ä»»åŠ¡æ•°é‡å˜åŒ–è¾ƒå¤§çš„åœºæ™¯
- âœ… **èµ„æºå—é™** - éœ€è¦ç²¾ç¡®æ§åˆ¶çº¿ç¨‹æ•°é‡
- âœ… **å¿«é€Ÿå¼€å‘** - åŸºäºç°æœ‰ç»„ä»¶å¿«é€Ÿå®ç°
- âœ… **ç³»ç»Ÿä¸€è‡´æ€§** - ä¿æŒä¸ç°æœ‰æ¶æ„çš„ä¸€è‡´æ€§

#### è‡ªå®šä¹‰çº¿ç¨‹æ–¹æ¡ˆé€‚åˆï¼š
- âœ… **æè‡´æ€§èƒ½** - éœ€è¦æœ€ä½å»¶è¿Ÿçš„åœºæ™¯
- âœ… **å›ºå®šè´Ÿè½½** - äº‹ä»¶å¤„ç†é‡ç›¸å¯¹ç¨³å®š
- âœ… **ä¸“ç”¨ä¼˜åŒ–** - éœ€è¦é’ˆå¯¹ç‰¹å®šåœºæ™¯ä¼˜åŒ–
- âœ… **å®Œå…¨æ§åˆ¶** - éœ€è¦ç²¾ç¡®æ§åˆ¶çº¿ç¨‹è¡Œä¸º

### 6. å®ç°ç»†èŠ‚å¯¹æ¯”

#### çº¿ç¨‹æ± æ–¹æ¡ˆæ ¸å¿ƒä»£ç 
```c
// äº‹ä»¶è·å–ä»»åŠ¡
void *linx_event_fetch_task(void *arg, int *should_stop) {
    // 1. è°ƒç”¨ linx_engine_next()
    // 2. è°ƒç”¨ linx_event_rich()
    // 3. æ¨é€åˆ°é˜Ÿåˆ—
    // 4. æäº¤åŒ¹é…ä»»åŠ¡
    linx_event_processor_v2_submit_match_task(&event);
}

// è§„åˆ™åŒ¹é…ä»»åŠ¡
void *linx_rule_match_task(void *arg, int *should_stop) {
    // 1. ä»é˜Ÿåˆ—è·å–äº‹ä»¶
    // 2. è°ƒç”¨ linx_rule_set_match_rule()
    // 3. æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
}
```

#### è‡ªå®šä¹‰çº¿ç¨‹æ–¹æ¡ˆæ ¸å¿ƒä»£ç 
```c
// ä¸“ç”¨äº‹ä»¶è·å–çº¿ç¨‹
void *linx_event_fetcher_thread(void *arg) {
    while (!shutdown) {
        // 1. è°ƒç”¨ linx_engine_next()
        // 2. è°ƒç”¨ linx_event_rich()
        // 3. æ¨é€åˆ°é˜Ÿåˆ—
        linx_event_queue_push_event(queue, &event);
    }
}

// ä¸“ç”¨è§„åˆ™åŒ¹é…çº¿ç¨‹
void *linx_rule_matcher_thread(void *arg) {
    while (!shutdown) {
        // 1. ä»é˜Ÿåˆ—è·å–äº‹ä»¶
        linx_event_queue_pop_event(queue, &event);
        // 2. è°ƒç”¨ linx_rule_set_match_rule()
    }
}
```

### 7. ç›‘æ§å’Œè°ƒè¯•

#### çº¿ç¨‹æ± æ–¹æ¡ˆ
```c
// ä¸°å¯Œçš„ç›‘æ§ä¿¡æ¯
linx_event_processor_v2_get_stats(&total, &processed, &matched, &failed);
linx_event_processor_v2_get_queue_status(&queue_size, &fetcher_active, &matcher_active);

// åˆ©ç”¨ç°æœ‰çº¿ç¨‹æ± ç›‘æ§
int active = linx_thread_pool_get_active_threads(pool);
int queue = linx_thread_pool_get_queue_size(pool);
```

#### è‡ªå®šä¹‰çº¿ç¨‹æ–¹æ¡ˆ
```c
// åŸºç¡€ç›‘æ§ä¿¡æ¯
linx_event_processor_get_stats(&total, &processed, &matched);

// éœ€è¦è‡ªå·±å®ç°çº¿ç¨‹çŠ¶æ€ç›‘æ§
// ç›¸å¯¹ç®€å•ä½†åŠŸèƒ½æœ‰é™
```

### 8. å†…å­˜ç®¡ç†

#### çº¿ç¨‹æ± æ–¹æ¡ˆ
- **ä¼˜åŠ¿**: ä»»åŠ¡å®Œæˆåè‡ªåŠ¨é‡Šæ”¾ï¼Œå†…å­˜ç®¡ç†ç®€å•
- **æ³¨æ„**: éœ€è¦æ­£ç¡®ç®¡ç†ä»»åŠ¡å‚æ•°çš„ç”Ÿå‘½å‘¨æœŸ

#### è‡ªå®šä¹‰çº¿ç¨‹æ–¹æ¡ˆ
- **ä¼˜åŠ¿**: å†…å­˜ä½¿ç”¨æ¨¡å¼å›ºå®šï¼Œæ˜“äºé¢„æµ‹
- **æ³¨æ„**: éœ€è¦æ‰‹åŠ¨ç®¡ç†çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ

### 9. é”™è¯¯å¤„ç†

#### çº¿ç¨‹æ± æ–¹æ¡ˆ
- **ä¼˜åŠ¿**: åˆ©ç”¨ç°æœ‰çº¿ç¨‹æ± çš„é”™è¯¯å¤„ç†æœºåˆ¶
- **ç‰¹ç‚¹**: ä»»åŠ¡å¤±è´¥ä¸å½±å“çº¿ç¨‹æ± æ•´ä½“è¿è¡Œ

#### è‡ªå®šä¹‰çº¿ç¨‹æ–¹æ¡ˆ
- **ä¼˜åŠ¿**: å¯ä»¥é’ˆå¯¹æ€§åœ°å¤„ç†ç‰¹å®šç±»å‹çš„é”™è¯¯
- **ç‰¹ç‚¹**: éœ€è¦è‡ªå·±å®ç°å®Œæ•´çš„é”™è¯¯å¤„ç†é€»è¾‘

## æ¨èæ–¹æ¡ˆ

### ğŸ† **æ¨èä½¿ç”¨çº¿ç¨‹æ± æ–¹æ¡ˆ**

**ç†ç”±**ï¼š
1. **å……åˆ†åˆ©ç”¨ç°æœ‰åŸºç¡€è®¾æ–½** - æ‚¨çš„`linx_thread_pool`å·²ç»è¿‡æµ‹è¯•å’Œä¼˜åŒ–
2. **å¼€å‘æ•ˆç‡é«˜** - åŸºäºç°æœ‰ç»„ä»¶å¿«é€Ÿå®ç°
3. **ç»´æŠ¤æˆæœ¬ä½** - å¤ç”¨ç°æœ‰çš„çº¿ç¨‹ç®¡ç†é€»è¾‘
4. **åŠŸèƒ½ä¸°å¯Œ** - æ”¯æŒåŠ¨æ€ä»»åŠ¡æäº¤ã€è´Ÿè½½å‡è¡¡ç­‰é«˜çº§ç‰¹æ€§
5. **ç³»ç»Ÿä¸€è‡´æ€§** - ä¸ç°æœ‰æ¶æ„ä¿æŒä¸€è‡´

### å®æ–½å»ºè®®

1. **ç¬¬ä¸€é˜¶æ®µ**: ä½¿ç”¨çº¿ç¨‹æ± æ–¹æ¡ˆå¿«é€Ÿå®ç°åŸºæœ¬åŠŸèƒ½
2. **ç¬¬äºŒé˜¶æ®µ**: æ ¹æ®å®é™…æ€§èƒ½éœ€æ±‚è¿›è¡Œä¼˜åŒ–
3. **ç¬¬ä¸‰é˜¶æ®µ**: å¦‚æœ‰å¿…è¦ï¼Œå¯ä»¥è€ƒè™‘æ··åˆæ–¹æ¡ˆæˆ–åˆ‡æ¢åˆ°è‡ªå®šä¹‰çº¿ç¨‹

### ä»£ç ç¤ºä¾‹

```c
// åˆå§‹åŒ–
linx_event_processor_v2_config_t config = {
    .event_fetcher_pool_size = 4,     // CPUæ ¸æ•°
    .rule_matcher_pool_size = 8,      // CPUæ ¸æ•°*2
    .event_queue_size = 1000,
    .batch_size = 10
};

linx_event_processor_v2_init(&config);
linx_event_processor_v2_start();

// è¿è¡Œæ—¶åŠ¨æ€è°ƒæ•´
linx_event_processor_v2_submit_fetch_tasks(additional_count);
```

è¿™ç§æ–¹æ¡ˆæ—¢æ»¡è¶³äº†æ‚¨çš„åŠŸèƒ½éœ€æ±‚ï¼Œåˆå……åˆ†åˆ©ç”¨äº†ç°æœ‰çš„ä»£ç åŸºç¡€ï¼Œæ˜¯æœ€ä½³çš„é€‰æ‹©ã€‚